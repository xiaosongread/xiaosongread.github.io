<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">

    

    

    <title>再读 pinia 官方文档 | 前端技术博客</title>
    <meta name="author" content="xiaosongread">
    <meta name="keywords" content="小宋 抿圪斗前端 前端 前端博客 框架 工程 css html js node markdown npm webpack">
    <meta name="description" content="安装用你喜欢的包管理器安装 pinia：123yarn add pinia# 或者使用 npmnpm install pinia如果你的应用使用的 Vue 版本低于 2.7，你还需要安装组合式 API 包：@vue/composition-api。创建一个 pinia 实例创建一个 pinia 实例 (根 store) 并将其传递给应用：123456789import &amp;#123; createApp &amp;#125; from &#39;vue&#39;import &amp;#123; create...">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">

    
    <link rel="alternate" href="/atom.xml" title="前端技术博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    <link rel="stylesheet" href="/css/style.css">

    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
</head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">前端技术博客</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">列表</span>
            </a>
        
            <a class="nav-item" href="/">
                <span class="nav-text">首页</span>
            </a>
        
            <a class="nav-item" href="/categories/css-end/">
                <span class="nav-text">css</span>
            </a>
        
            <a class="nav-item" href="/categories/js-end/">
                <span class="nav-text">js</span>
            </a>
        
            <a class="nav-item" href="/categories/gc-end/">
                <span class="nav-text">工程</span>
            </a>
        
            <a class="nav-item" href="/categories/sh-end/">
                <span class="nav-text">日常</span>
            </a>
        
            <a class="nav-item" href="/categories/my-end/">
                <span class="nav-text">关于我</span>
            </a>
        
    </nav>
</div>

    
<aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-number">1.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建一个-pinia-实例"><span class="toc-number">1.1.</span> <span class="toc-text">创建一个 pinia 实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应该在什么时候使用-Store"><span class="toc-number">1.2.</span> <span class="toc-text">应该在什么时候使用 Store?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么时候不应该使用-Store"><span class="toc-number">1.3.</span> <span class="toc-text">什么时候不应该使用 Store?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定义-Store"><span class="toc-number">2.</span> <span class="toc-text">定义 Store</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Option-Store"><span class="toc-number">2.1.</span> <span class="toc-text">Option Store</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setup-Store"><span class="toc-number">2.2.</span> <span class="toc-text">Setup Store</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#你应该选用哪种语法？"><span class="toc-number">2.3.</span> <span class="toc-text">你应该选用哪种语法？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-Store"><span class="toc-number">2.4.</span> <span class="toc-text">使用 Store</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从-Store-解构-storeToRefs"><span class="toc-number">2.5.</span> <span class="toc-text">从 Store 解构 - storeToRefs()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#state"><span class="toc-number">3.</span> <span class="toc-text">state</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TypeScript"><span class="toc-number">3.1.</span> <span class="toc-text">TypeScript</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#访问-state"><span class="toc-number">3.2.</span> <span class="toc-text">访问 state</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重置state"><span class="toc-number">3.3.</span> <span class="toc-text">重置state</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用选项式-API-的用法"><span class="toc-number">3.4.</span> <span class="toc-text">使用选项式 API 的用法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#可修改的-state"><span class="toc-number">3.4.1.</span> <span class="toc-text">可修改的 state</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#变更-state-patch"><span class="toc-number">3.5.</span> <span class="toc-text">变更 state - $patch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#替换-state"><span class="toc-number">3.6.</span> <span class="toc-text">替换 state</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#订阅-state-subscribe"><span class="toc-number">3.7.</span> <span class="toc-text">订阅 state - $subscribe()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#刷新时机"><span class="toc-number">3.8.</span> <span class="toc-text">刷新时机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#取消订阅"><span class="toc-number">3.9.</span> <span class="toc-text">取消订阅</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Getter"><span class="toc-number">4.</span> <span class="toc-text">Getter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#访问其他-getter"><span class="toc-number">4.1.</span> <span class="toc-text">访问其他 getter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#向-getter-传递参数"><span class="toc-number">4.2.</span> <span class="toc-text">向 getter 传递参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#访问其他-store-的-getter"><span class="toc-number">4.3.</span> <span class="toc-text">访问其他 store 的 getter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-setup-时的用法"><span class="toc-number">4.4.</span> <span class="toc-text">使用 setup() 时的用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用选项式-API-的用法-1"><span class="toc-number">4.5.</span> <span class="toc-text">使用选项式 API 的用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Action"><span class="toc-number">5.</span> <span class="toc-text">Action</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#访问其他-store-的-action"><span class="toc-number">5.1.</span> <span class="toc-text">访问其他 store 的 action</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用选项式-API-的用法-2"><span class="toc-number">5.2.</span> <span class="toc-text">使用选项式 API 的用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#订阅-action"><span class="toc-number">5.3.</span> <span class="toc-text">订阅 action</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件"><span class="toc-number">6.</span> <span class="toc-text">插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">6.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩展-store"><span class="toc-number">6.2.</span> <span class="toc-text">扩展 store</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在组件外使用-store"><span class="toc-number">7.</span> <span class="toc-text">在组件外使用 store</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#单页面应用"><span class="toc-number">7.1.</span> <span class="toc-text">单页面应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端渲染应用"><span class="toc-number">7.2.</span> <span class="toc-text">服务端渲染应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务端渲染-SSR"><span class="toc-number">8.</span> <span class="toc-text">服务端渲染 (SSR)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在-setup-外部使用-store"><span class="toc-number">8.1.</span> <span class="toc-text">在 setup() 外部使用 store</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#State-激活"><span class="toc-number">8.2.</span> <span class="toc-text">State 激活</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nuxt"><span class="toc-number">8.3.</span> <span class="toc-text">Nuxt</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装-1"><span class="toc-number">8.3.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在-setup-外部使用-store-1"><span class="toc-number">8.3.2.</span> <span class="toc-text">在 setup() 外部使用 store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自动引入"><span class="toc-number">8.3.3.</span> <span class="toc-text">自动引入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#纯-Nuxt-2"><span class="toc-number">8.3.4.</span> <span class="toc-text">纯 Nuxt 2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pinia-搭配-Vuex-使用"><span class="toc-number">8.3.5.</span> <span class="toc-text">Pinia 搭配 Vuex 使用</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            再读 pinia 官方文档
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://www.shuy.cc/2025/09/10/pina/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2025-09-10T08:45:53.000Z" itemprop="datePublished">2025-09-10</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>用你喜欢的包管理器安装 <code>pinia</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn add pinia</span><br><span class="line"><span class="comment"># 或者使用 npm</span></span><br><span class="line">npm install pinia</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果你的应用使用的 Vue 版本低于 <code>2.7</code>，你还需要安装组合式 API 包：<code>@vue/composition-api</code>。</p>
</blockquote>
<h3 id="创建一个-pinia-实例"><a href="#创建一个-pinia-实例" class="headerlink" title="创建一个 pinia 实例"></a><strong>创建一个 pinia 实例</strong></h3><a id="more"></a>
<p>创建一个 pinia 实例 (根 store) 并将其传递给应用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line"></span><br><span class="line">app.use(pinia)</span><br><span class="line">app.mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<p>如果你使用的是 <code>Vue 2</code>，你还需要安装一个插件，并在应用的根部注入创建的 <code>pinia</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createPinia, PiniaVuePlugin &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line">Vue.use(PiniaVuePlugin)</span><br><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  <span class="comment">// 其他配置...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// 请注意，同一个`pinia'实例</span></span><br><span class="line">  <span class="comment">// 可以在同一个页面的多个 Vue 应用中使用。</span></span><br><span class="line">  pinia,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这样才能提供 devtools 的支持。在 Vue 3 中，一些功能仍然不被支持，如 time traveling 和编辑，这是因为 vue-devtools 还没有相关的 API，但 devtools 也有很多针对 Vue 3 的专属功能，而且就开发者的体验来说，Vue 3 整体上要好得多。在 Vue 2 中，Pinia 使用的是 Vuex 的现有接口 (因此不能与 Vuex 一起使用) 。</p>
<h3 id="应该在什么时候使用-Store"><a href="#应该在什么时候使用-Store" class="headerlink" title="应该在什么时候使用 Store?"></a><strong>应该在什么时候使用 Store?</strong></h3><p>一个 Store 应该包含可以在整个应用中访问的数据。这包括在许多地方使用的数据，例如显示在导航栏中的用户信息，以及需要通过页面保存的数据，例如一个非常复杂的多步骤表单。</p>
<p>另一方面，你应该避免在 Store 中引入那些原本可以在组件中保存的本地数据，例如，一个元素在页面中的可见性。</p>
<p>并非所有的应用都需要访问全局状态，但如果你的应用确实需要一个全局状态，那 Pinia 将使你的开发过程更轻松。</p>
<h3 id="什么时候不应该使用-Store"><a href="#什么时候不应该使用-Store" class="headerlink" title="什么时候不应该使用 Store?"></a><strong>什么时候不应该使用 Store?</strong></h3><p>有的时候我们会过度使用 store。如果觉得应用程序的 store 过多，你可能需要重新考虑使用 store 的目的。例如其中一些逻辑应该只是组合式函数，或者应该只是组件的本地状态。</p>
<hr>
<h2 id="定义-Store"><a href="#定义-Store" class="headerlink" title="定义 Store"></a>定义 Store</h2><p>Store 是用 <code>defineStore()</code> 定义的，它的第一个参数要求是一个独一无二的名字：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  `defineStore()` 的返回值的命名是自由的</span></span><br><span class="line"><span class="comment">// 但最好含有 store 的名字，且以 `use` 开头，以 `Store` 结尾。</span></span><br><span class="line"><span class="comment">// (比如 `useUserStore`，`useCartStore`，`useProductStore`)</span></span><br><span class="line"><span class="comment">// 第一个参数是你的应用中 Store 的唯一 ID。</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useAlertsStore = defineStore(<span class="string">'alerts'</span>, &#123;</span><br><span class="line">  <span class="comment">// 其他配置...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这个名字 ，也被用作 id ，是必须传入的， Pinia 将用它来连接 store 和 devtools。为了养成习惯性的用法，将返回的函数命名为 use… 是一个符合组合式函数风格的约定。</p>
<p><code>defineStore()</code> 的第二个参数可接受两类值：<code>Setup 函数</code>或 <code>Option 对象</code>。</p>
<h3 id="Option-Store"><a href="#Option-Store" class="headerlink" title="Option Store"></a>Option Store</h3><p>与 Vue 的选项式 API 类似，我们也可以传入一个带有 <code>state</code>、<code>actions</code> 与 <code>getters</code> 属性的 Option 对象</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123; count: <span class="number">0</span>, name: <span class="string">'Eduardo'</span> &#125;),</span><br><span class="line">  getters: &#123;</span><br><span class="line">    doubleCount: <span class="function">(<span class="params">state</span>) =&gt;</span> state.count * <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count++</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>你可以认为 <code>state</code> 是 store 的数据 (<code>data</code>)<code>，getters</code> 是 store 的计算属性 (<code>computed</code>)，而 <code>actions</code> 则是方法 (<code>methods</code>)。</p>
<p>为方便上手使用，Option Store 应尽可能直观简单。</p>
<h3 id="Setup-Store"><a href="#Setup-Store" class="headerlink" title="Setup Store"></a>Setup Store</h3><p>也存在另一种定义 store 的可用语法。与 Vue 组合式 API 的 setup 函数 相似，我们可以传入一个函数，该函数定义了一些响应式属性和方法，并且返回一个带有我们想暴露出去的属性和方法的对象。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> count = ref(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> name = ref(<span class="string">'Eduardo'</span>)</span><br><span class="line">  <span class="keyword">const</span> doubleCount = computed(<span class="function"><span class="params">()</span> =&gt;</span> count.value * <span class="number">2</span>)</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    count.value++</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; count, name, doubleCount, increment &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在 <strong><em>Setup Store</em></strong> 中：</p>
<ul>
<li><code>ref()</code> 就是 <code>state</code> 属性</li>
<li><code>computed()</code> 就是 <code>getters</code> 属性</li>
<li><code>function()</code> 就是 <code>actions</code> 属性</li>
</ul>
<p>注意，要让 pinia 正确识别 <code>state</code>，你必须在 setup store 中返回 <code>state</code> 的所有属性。这意味着，你不能在 store 中使用私有属性。不完整返回会影响 <code>SSR</code> ，开发工具和其他插件的正常运行。</p>
<p><code>Setup store</code> 比 <code>Option Store</code> 带来了更多的灵活性，因为你可以在一个 <code>store</code> 内创建侦听器，并自由地使用任何组合式函数。不过，请记住，使用组合式函数会让 <code>SSR</code> 变得更加复杂。</p>
<p>Setup store 也可以依赖于全局提供的属性，比如路由。任何<strong>应用层面</strong>提供的属性都可以在 store 中使用 <code>inject()</code> 访问，就像在组件中一样：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; inject &#125; <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useRoute &#125; <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useSearchFilters = defineStore(<span class="string">'search-filters'</span>, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> route = useRoute()</span><br><span class="line">  <span class="comment">// 这里假定 `app.provide('appProvided', 'value')` 已经调用过</span></span><br><span class="line">  <span class="keyword">const</span> appProvided = inject(<span class="string">'appProvided'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>不要返回像 <code>route</code> 或 <code>appProvided</code> (上例中)之类的属性，因为它们不属于 store，而且你可以在组件中直接用 <code>useRoute()</code> 和 <code>inject(&#39;appProvided&#39;)</code> 访问。</p>
</blockquote>
<h3 id="你应该选用哪种语法？"><a href="#你应该选用哪种语法？" class="headerlink" title="你应该选用哪种语法？"></a>你应该选用哪种语法？</h3><p>和在 Vue 中如何选择组合式 API 与选项式 API 一样，选择你觉得最舒服的那一个就好。两种语法都有各自的优势和劣势。Option Store 更容易使用，而 Setup Store 更灵活和强大。</p>
<h3 id="使用-Store"><a href="#使用-Store" class="headerlink" title="使用 Store"></a>使用 Store</h3><p>虽然我们前面定义了一个 store，但在我们使用 <code>&lt;script setup&gt;</code> 调用 <code>useStore()</code>(或者使用 <code>setup()</code> 函数，像所有的组件那样) 之前，store 实例是不会被创建的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useCounterStore &#125; <span class="keyword">from</span> <span class="string">'@/stores/counter'</span></span><br><span class="line"><span class="comment">// 在组件内部的任何地方均可以访问变量 `store` ✨</span></span><br><span class="line"><span class="keyword">const</span> store = useCounterStore()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>请注意，<code>store</code> 是一个用 <code>reactive</code> 包装的对象，这意味着不需要在 <code>getters</code> 后面写 <code>.value</code>。就像 <code>setup</code> 中的 <code>props</code> 一样，我们不能对它进行解构：<br><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; useCounterStore &#125; <span class="keyword">from</span> <span class="string">'@/stores/counter'</span></span><br><span class="line"><span class="keyword">import</span> &#123; computed &#125; <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = useCounterStore()</span><br><span class="line"><span class="comment">// ❌ 下面这部分代码不会生效，因为它的响应式被破坏了</span></span><br><span class="line"><span class="comment">// 与 reactive 相同: https://vuejs.org/guide/essentials/reactivity-fundamentals.html#limitations-of-reactive</span></span><br><span class="line"><span class="keyword">const</span> &#123; name, doubleCount &#125; = store</span><br><span class="line">name <span class="comment">// 将会一直是 "Eduardo" //</span></span><br><span class="line">doubleCount <span class="comment">// 将会一直是 0 //</span></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  store.increment()</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"><span class="comment">// ✅ 而这一部分代码就会维持响应式</span></span><br><span class="line"><span class="comment">// 💡 在这里你也可以直接使用 `store.doubleCount`</span></span><br><span class="line"><span class="keyword">const</span> doubleValue = computed(<span class="function"><span class="params">()</span> =&gt;</span> store.doubleCount)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="从-Store-解构-storeToRefs"><a href="#从-Store-解构-storeToRefs" class="headerlink" title="从 Store 解构 - storeToRefs()"></a>从 Store 解构 - storeToRefs()</h3><p>为了从 store 中提取属性时保持其响应性，你需要使用 <code>storeToRefs()</code>。它将为每一个响应式属性创建引用。当你只使用 store 的状态而不调用任何 action 时，它会非常有用。请注意，你可以直接从 store 中解构 action，因为它们也被绑定到 store 上：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; storeToRefs &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"><span class="keyword">const</span> store = useCounterStore()</span><br><span class="line"><span class="comment">// `name` 和 `doubleCount` 都是响应式引用</span></span><br><span class="line"><span class="comment">// 下面的代码同样会提取那些来自插件的属性的响应式引用</span></span><br><span class="line"><span class="comment">// 但是会跳过所有的 action 或者非响应式（非 ref 或者 非 reactive）的属性</span></span><br><span class="line"><span class="keyword">const</span> &#123; name, doubleCount &#125; = storeToRefs(store)</span><br><span class="line"><span class="comment">// 名为 increment 的 action 可以被解构</span></span><br><span class="line"><span class="keyword">const</span> &#123; increment &#125; = store</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="state"><a href="#state" class="headerlink" title="state"></a>state</h2><p>在 Pinia 中，state 被定义为一个返回初始状态的函数。这使得 Pinia 可以同时支持<code>服务端</code>和<code>客户端</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useStore = defineStore(<span class="string">'storeId'</span>, &#123;</span><br><span class="line">  <span class="comment">// 为了完整类型推理，推荐使用箭头函数</span></span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 所有这些属性都将自动推断出它们的类型</span></span><br><span class="line">      count: <span class="number">0</span>,</span><br><span class="line">      name: <span class="string">'Eduardo'</span>,</span><br><span class="line">      isAdmin: <span class="literal">true</span>,</span><br><span class="line">      items: [],</span><br><span class="line">      hasChanged: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h3><p>你并不需要做太多努力就能使你的 state 兼容 TS。确保启用了 strict，或者至少启用了 noImplicitThis，Pinia 将自动推断您的状态类型！ 但是，在某些情况下，您应该帮助它进行一些转换：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useStore = defineStore(<span class="string">'storeId'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// 用于初始化空列表</span></span><br><span class="line">      userList: [] <span class="keyword">as</span> UserInfo[],</span><br><span class="line">      <span class="comment">// 用于尚未加载的数据</span></span><br><span class="line">      user: <span class="literal">null</span> <span class="keyword">as</span> UserInfo | <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> UserInfo &#123;</span><br><span class="line">  name: <span class="built_in">string</span></span><br><span class="line">  age: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你愿意，你可以用一个接口定义 state，并添加 state() 的返回值的类型。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> State &#123;</span><br><span class="line">  userList: UserInfo[]</span><br><span class="line">  user: UserInfo | <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useStore = defineStore(<span class="string">'storeId'</span>, &#123;</span><br><span class="line">  state: (): <span class="function"><span class="params">State</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      userList: [],</span><br><span class="line">      user: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> UserInfo &#123;</span><br><span class="line">  name: <span class="built_in">string</span></span><br><span class="line">  age: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="访问-state"><a href="#访问-state" class="headerlink" title="访问 state"></a>访问 state</h3><p>默认情况下，你可以通过 <code>store</code> 实例访问 state，直接对其进行读写。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = useStore()</span><br><span class="line"></span><br><span class="line">store.count++</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意，新的属性如果没有在 <code>state()</code> 中被定义，则不能被添加。它<code>必须</code>包含初始状态。</p>
</blockquote>
<h3 id="重置state"><a href="#重置state" class="headerlink" title="重置state"></a>重置state</h3><ul>
<li>使用 <strong><em>选项式 API</em></strong> 时，你可以通过调用 store 的 <code>$reset()</code> 方法将 state 重置为初始值。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = useStore()</span><br><span class="line"></span><br><span class="line">store.$reset()</span><br></pre></td></tr></table></figure>
<p>在 <code>$reset()</code> 内部，会调用 <code>state()</code> 函数来创建一个新的状态对象，并用它替换当前状态。</p>
<hr>
<ul>
<li>在 <strong><em>Setup Stores</em></strong> 中，您需要<code>创建自己的</code> $reset() 方法：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> count = ref(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">$reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    count.value = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; count, $reset &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="使用选项式-API-的用法"><a href="#使用选项式-API-的用法" class="headerlink" title="使用选项式 API 的用法"></a>使用选项式 API 的用法</h3><p>在下面的例子中，你可以假设相关 store 已经创建了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例文件路径：</span></span><br><span class="line"><span class="comment">// ./src/stores/counter.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果你不能使用组合式 API，但你可以使用 computed，methods，…，那你可以使用 <code>mapState()</code> 辅助函数将 state 属性映射为只读的计算属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mapState &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useCounterStore &#125; <span class="keyword">from</span> <span class="string">'../stores/counter'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  computed: &#123;</span><br><span class="line">    <span class="comment">// 可以访问组件中的 this.count</span></span><br><span class="line">    <span class="comment">// 与从 store.count 中读取的数据相同</span></span><br><span class="line">    ...mapState(useCounterStore, [<span class="string">'count'</span>])</span><br><span class="line">    <span class="comment">// 与上述相同，但将其注册为 this.myOwnName</span></span><br><span class="line">    ...mapState(useCounterStore, &#123;</span><br><span class="line">      myOwnName: <span class="string">'count'</span>,</span><br><span class="line">      <span class="comment">// 你也可以写一个函数来获得对 store 的访问权</span></span><br><span class="line">      double: <span class="function"><span class="params">store</span> =&gt;</span> store.count * <span class="number">2</span>,</span><br><span class="line">      <span class="comment">// 它可以访问 `this`，但它没有标注类型...</span></span><br><span class="line">      magicValue(store) &#123;</span><br><span class="line">        <span class="keyword">return</span> store.someGetter + <span class="keyword">this</span>.count + <span class="keyword">this</span>.double</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="可修改的-state"><a href="#可修改的-state" class="headerlink" title="可修改的 state"></a>可修改的 state</h4><p>如果你想修改这些 state 属性 (例如，如果你有一个表单)，你可以使用 mapWritableState() 作为代替。但注意你不能像 mapState() 那样传递一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mapWritableState &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useCounterStore &#125; <span class="keyword">from</span> <span class="string">'../stores/counter'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  computed: &#123;</span><br><span class="line">    <span class="comment">// 可以访问组件中的 this.count，并允许设置它。</span></span><br><span class="line">    <span class="comment">// this.count++</span></span><br><span class="line">    <span class="comment">// 与从 store.count 中读取的数据相同</span></span><br><span class="line">    ...mapWritableState(useCounterStore, [<span class="string">'count'</span>])</span><br><span class="line">    <span class="comment">// 与上述相同，但将其注册为 this.myOwnName</span></span><br><span class="line">    ...mapWritableState(useCounterStore, &#123;</span><br><span class="line">      myOwnName: <span class="string">'count'</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="变更-state-patch"><a href="#变更-state-patch" class="headerlink" title="变更 state - $patch"></a>变更 state - $patch</h3><p>除了用 <code>store.count++</code> 直接改变 store，你还可以调用 <code>$patch</code> 方法。它允许你用一个 <code>state</code> 的补丁对象在同一时间更改多个属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">store.$patch(&#123;</span><br><span class="line">  count: store.count + <span class="number">1</span>,</span><br><span class="line">  age: <span class="number">120</span>,</span><br><span class="line">  name: <span class="string">'DIO'</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>不过，用这种语法的话，有些变更真的很难实现或者很耗时：任何集合的修改（例如，向数组中添加、移除一个元素或是做 <code>splice</code> 操作）都需要你创建一个新的集合。因此，<code>$patch</code> 方法也接受一个函数来组合这种难以用补丁对象实现的变更。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">store.$patch(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  state.items.push(&#123; <span class="attr">name</span>: <span class="string">'shoes'</span>, <span class="attr">quantity</span>: <span class="number">1</span> &#125;)</span><br><span class="line">  state.hasChanged = <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>两种变更 store 方法的主要区别是，$patch() 允许你将多个变更归入 devtools 的同一个条目中。同时请注意，直接修改 state，$patch() 也会出现在 devtools 中，而且可以进行 time travel (在 Vue 3 中还没有)。</p>
<h3 id="替换-state"><a href="#替换-state" class="headerlink" title="替换 state"></a>替换 state</h3><p>你不能完全替换掉 store 的 state，因为那样会破坏其响应性。但是，你可以 <strong><em>patch</em></strong> 它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这实际上并没有替换`$state`</span></span><br><span class="line">store.$state = &#123; <span class="attr">count</span>: <span class="number">24</span> &#125;</span><br><span class="line"><span class="comment">// 在它内部调用 `$patch()`：</span></span><br><span class="line">store.$patch(&#123; <span class="attr">count</span>: <span class="number">24</span> &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="订阅-state-subscribe"><a href="#订阅-state-subscribe" class="headerlink" title="订阅 state - $subscribe()"></a>订阅 state - $subscribe()</h3><p>类似于 Vuex 的 <code>subscribe</code> 方法，你可以通过 store 的 <code>$subscribe()</code> 方法侦听 state 及其变化。比起普通的 <code>watch()</code>，使用 <code>$subscribe()</code> 的好处是 <strong><em>subscriptions</em></strong> 在 <strong><em>patch</em></strong> 后只触发一次 (例如，当使用上面的函数版本时)。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cartStore.$subscribe(<span class="function">(<span class="params">mutation, state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// import &#123; MutationType &#125; from 'pinia'</span></span><br><span class="line">  mutation.type <span class="comment">// 'direct' | 'patch object' | 'patch function'</span></span><br><span class="line">  <span class="comment">// 和 cartStore.$id 一样</span></span><br><span class="line">  mutation.storeId <span class="comment">// 'cart'</span></span><br><span class="line">  <span class="comment">// 只有 mutation.type === 'patch object'的情况下才可用</span></span><br><span class="line">  mutation.payload <span class="comment">// 传递给 cartStore.$patch() 的补丁对象。</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每当状态发生变化时，将整个 state 持久化到本地存储。</span></span><br><span class="line">  localStorage.setItem(<span class="string">'cart'</span>, <span class="built_in">JSON</span>.stringify(state))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="刷新时机"><a href="#刷新时机" class="headerlink" title="刷新时机"></a>刷新时机</h3><p>在底层实现上，<code>$subscribe()</code> 使用了 Vue 的 <code>watch()</code> 函数。你可以传入与 <code>watch()</code> 相同的选项。当你想要在 每次 state 变化后立即触发订阅时很有用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cartStore.$subscribe(<span class="function">(<span class="params">mutation, state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 每当状态发生变化时，将整个 state 持久化到本地存储</span></span><br><span class="line">  localStorage.setItem(<span class="string">'cart'</span>, <span class="built_in">JSON</span>.stringify(state))</span><br><span class="line">&#125;, &#123; <span class="attr">flush</span>: <span class="string">'sync'</span> &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="取消订阅"><a href="#取消订阅" class="headerlink" title="取消订阅"></a>取消订阅</h3><p>默认情况下，<strong><em>state subscription</em></strong> 会被绑定到添加它们的组件上 (如果 store 在组件的 <code>setup()</code> 里面)。这意味着，当该组件被卸载时，它们将被自动删除。如果你想在组件卸载后依旧保留它们，请将 <code>{ detached: true }</code> 作为第二个参数，以将 <strong><em>state subscription</em></strong> 从当前组件中分离：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">const</span> someStore = useSomeStore()</span><br><span class="line"><span class="comment">// 此订阅器即便在组件卸载之后仍会被保留</span></span><br><span class="line">someStore.$subscribe(callback, &#123; <span class="attr">detached</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>你可以在 <code>pinia</code> 实例上使用 <code>watch()</code> 函数侦听整个 state。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">watch(</span><br><span class="line">  pinia.state,</span><br><span class="line">  (state) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 每当状态发生变化时，将整个 state 持久化到本地存储。</span></span><br><span class="line">    localStorage.setItem(<span class="string">'piniaState'</span>, <span class="built_in">JSON</span>.stringify(state))</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">deep</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<h2 id="Getter"><a href="#Getter" class="headerlink" title="Getter"></a>Getter</h2><p>Getter 完全等同于 store 的 state 的计算值。可以通过 defineStore() 中的 <code>getters</code> 属性来定义它们。推荐使用箭头函数，并且它将接收 <code>state</code> 作为第一个参数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  getters: &#123;</span><br><span class="line">    doubleCount: <span class="function">(<span class="params">state</span>) =&gt;</span> state.count * <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>大多数时候，getter 仅依赖 state。不过，有时它们也可能会使用其他 getter。因此，即使在使用常规函数定义 getter 时，我们也可以通过 <code>this</code> 访问到整个 store 实例，但(在 TypeScript 中)必须定义返回类型。这是为了避免 TypeScript 的已知缺陷，不过这不影响用箭头函数定义的 getter，也不会影响不使用 <code>this</code> 的 getter。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  getters: &#123;</span><br><span class="line">    <span class="comment">// 自动推断出返回类型是一个 number</span></span><br><span class="line">    doubleCount(state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.count * <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 返回类型**必须**明确设置</span></span><br><span class="line">    doublePlusOne(): number &#123;</span><br><span class="line">      <span class="comment">// 整个 store 的 自动补全和类型标注 ✨</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.doubleCount + <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>然后你可以直接访问 store 实例上的 getter 了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; useCounterStore &#125; <span class="keyword">from</span> <span class="string">'./counterStore'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = useCounterStore()</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;template&gt;</span></span><br><span class="line"><span class="regexp">  &lt;p&gt;Double count is &#123;&#123; store.doubleCount &#125;&#125;&lt;/</span>p&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="访问其他-getter"><a href="#访问其他-getter" class="headerlink" title="访问其他 getter"></a>访问其他 getter</h3><p>与计算属性一样，你也可以组合多个 getter。通过 <code>this</code>，你可以访问到其他任何 getter。在这种情况下，你需要为这个 getter 指定一个返回值的类型。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counterStore.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  getters: &#123;</span><br><span class="line">    doubleCount(state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.count * <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    doubleCountPlusOne(): <span class="built_in">number</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.doubleCount + <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// counterStore.js</span></span><br><span class="line"><span class="comment">// 你可以在 JavaScript 中使用 JSDoc (https://jsdoc.app/tags-returns.html)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  getters: &#123;</span><br><span class="line">    <span class="comment">// 类型是自动推断出来的，因为我们没有使用 `this`</span></span><br><span class="line">    doubleCount: <span class="function">(<span class="params">state</span>) =&gt;</span> state.count * <span class="number">2</span>,</span><br><span class="line">    <span class="comment">// 这里我们需要自己添加类型(在 JS 中使用 JSDoc)</span></span><br><span class="line">    <span class="comment">// 可以用 this 来引用 getter</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回 count 的值乘以 2 加 1</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @returns &#123;number&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    doubleCountPlusOne() &#123;</span><br><span class="line">      <span class="comment">// 自动补全 ✨</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.doubleCount + <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="向-getter-传递参数"><a href="#向-getter-传递参数" class="headerlink" title="向 getter 传递参数"></a>向 getter 传递参数</h3><p><strong><em>Getter</em></strong> 只是幕后的计算属性，所以不可以向它们传递任何参数。不过，你可以从 <strong><em>getter</em></strong> 返回一个函数，该函数可以接受任意参数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserListStore = defineStore(<span class="string">'userList'</span>, &#123;</span><br><span class="line">  getters: &#123;</span><br><span class="line">    getUserById: <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function">(<span class="params">userId</span>) =&gt;</span> state.users.find(<span class="function">(<span class="params">user</span>) =&gt;</span> user.id === userId)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>并在组件中使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useUserListStore &#125; <span class="keyword">from</span> <span class="string">'./store'</span></span><br><span class="line"><span class="keyword">const</span> userList = useUserListStore()</span><br><span class="line"><span class="keyword">const</span> &#123; getUserById &#125; = storeToRefs(userList)</span><br><span class="line"><span class="comment">// 请注意，你需要使用 `getUserById.value` 来访问</span></span><br><span class="line"><span class="comment">// &lt;script setup&gt; 中的函数</span></span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;p&gt;User <span class="number">2</span>: &#123;&#123; getUserById(<span class="number">2</span>) &#125;&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br></pre></td></tr></table></figure>
<p>请注意，当你这样做时，<strong>getter 将不再被缓存</strong>。它们只是一个被你调用的函数。不过，你可以在 getter 本身中缓存一些结果，虽然这种做法并不常见，但有证明表明它的性能会更好：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserListStore = defineStore(<span class="string">'userList'</span>, &#123;</span><br><span class="line">  getters: &#123;</span><br><span class="line">    getActiveUserById(state) &#123;</span><br><span class="line">      <span class="keyword">const</span> activeUsers = state.users.filter(<span class="function">(<span class="params">user</span>) =&gt;</span> user.active)</span><br><span class="line">      <span class="keyword">return</span> <span class="function">(<span class="params">userId</span>) =&gt;</span> activeUsers.find(<span class="function">(<span class="params">user</span>) =&gt;</span> user.id === userId)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="访问其他-store-的-getter"><a href="#访问其他-store-的-getter" class="headerlink" title="访问其他 store 的 getter"></a>访问其他 store 的 getter</h3><p>想要使用另一个 store 的 getter 的话，那就直接在 getter 内使用就好：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useOtherStore &#125; <span class="keyword">from</span> <span class="string">'./other-store'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useStore = defineStore(<span class="string">'main'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;),</span><br><span class="line">  getters: &#123;</span><br><span class="line">    otherGetter(state) &#123;</span><br><span class="line">      <span class="keyword">const</span> otherStore = useOtherStore()</span><br><span class="line">      <span class="keyword">return</span> state.localData + otherStore.data</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="使用-setup-时的用法"><a href="#使用-setup-时的用法" class="headerlink" title="使用 setup() 时的用法"></a>使用 setup() 时的用法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">const</span> store = useCounterStore()</span><br><span class="line">store.count = <span class="number">3</span></span><br><span class="line">store.doubleCount <span class="comment">// 6</span></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="使用选项式-API-的用法-1"><a href="#使用选项式-API-的用法-1" class="headerlink" title="使用选项式 API 的用法"></a>使用选项式 API 的用法</h3><p>在下面的例子中，你可以假设相关的 store 已经创建了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例文件路径：</span></span><br><span class="line"><span class="comment">// ./src/stores/counter.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'counter'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  getters: &#123;</span><br><span class="line">    doubleCount(state) &#123;</span><br><span class="line">      <span class="keyword">return</span> state.count * <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><p>Action 相当于组件中的 <code>method</code>。它们可以通过 <code>defineStore()</code> 中的 <code>actions</code> 属性来定义，并且它们也是定义业务逻辑的完美选择。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'main'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count++</span><br><span class="line">    &#125;,</span><br><span class="line">    randomizeCounter() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count = <span class="built_in">Math</span>.round(<span class="number">100</span> * <span class="built_in">Math</span>.random())</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>类似 <strong><em>getter</em></strong>，action 也可通过 <code>this</code> 访问整个 store 实例，并支持完整的类型标注(以及自动补全✨)。不同的是，<code>action</code> 可以是异步的，你可以在它们里面 <code>await</code> 调用任何 API，以及其他 action！<br>下面是一个使用 Mande 的例子。请注意，你使用什么库并不重要，只要你得到的是一个Promise。你甚至可以 (在浏览器中) 使用原生 fetch 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mande &#125; <span class="keyword">from</span> <span class="string">'mande'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> api = mande(<span class="string">'/api/users'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUsers = defineStore(<span class="string">'users'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    userData: <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;),</span><br><span class="line"></span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="keyword">async</span> registerUser(login, password) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.userData = <span class="keyword">await</span> api.post(&#123; login, password &#125;)</span><br><span class="line">        showTooltip(<span class="string">`Welcome back <span class="subst">$&#123;<span class="keyword">this</span>.userData.name&#125;</span>!`</span>)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        showTooltip(error)</span><br><span class="line">        <span class="comment">// 让表单组件显示错误</span></span><br><span class="line">        <span class="keyword">return</span> error</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>你也完全可以自由地设置任何你想要的参数以及返回任何结果。当调用 action 时，一切类型也都是可以被自动推断出来的。</p>
<p>Action 可以像函数或者通常意义上的方法一样被调用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">const</span> store = useCounterStore()</span><br><span class="line"><span class="comment">// 将 action 作为 store 的方法进行调用</span></span><br><span class="line">store.randomizeCounter()</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;template&gt;</span></span><br><span class="line"><span class="regexp">  &lt;!-- 即使在模板中也可以 --&gt;</span></span><br><span class="line"><span class="regexp">  &lt;button @click="store.randomizeCounter()"&gt;Randomize&lt;/</span>button&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="访问其他-store-的-action"><a href="#访问其他-store-的-action" class="headerlink" title="访问其他 store 的 action"></a>访问其他 store 的 action</h3><p>想要使用另一个 store 的话，那你直接在 <strong><em>action</em></strong> 中调用就好了：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useAuthStore &#125; <span class="keyword">from</span> <span class="string">'./auth-store'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useSettingsStore = defineStore(<span class="string">'settings'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    preferences: <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;),</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="keyword">async</span> fetchUserPreferences() &#123;</span><br><span class="line">      <span class="keyword">const</span> auth = useAuthStore()</span><br><span class="line">      <span class="keyword">if</span> (auth.isAuthenticated) &#123;</span><br><span class="line">        <span class="keyword">this</span>.preferences = <span class="keyword">await</span> fetchPreferences()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'User must be authenticated'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="使用选项式-API-的用法-2"><a href="#使用选项式-API-的用法-2" class="headerlink" title="使用选项式 API 的用法"></a>使用选项式 API 的用法</h3><p>在下面的例子中，你可以假设相关的 store 已经创建了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例文件路径：</span></span><br><span class="line"><span class="comment">// ./src/stores/counter.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = defineStore(<span class="string">'main'</span>, &#123;</span><br><span class="line">  state: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    count: <span class="number">0</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  actions: &#123;</span><br><span class="line">    increment() &#123;</span><br><span class="line">      <span class="keyword">this</span>.count++</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="订阅-action"><a href="#订阅-action" class="headerlink" title="订阅 action"></a>订阅 action</h3><p>你可以通过 <code>store.$onAction()</code> 来监听 action 和它们的结果。传递给它的回调函数会在 action 本身之前执行。<code>after</code> 表示在 promise 解决之后，允许你在 action 解决后执行一个回调函数。同样地，<code>onError</code> 允许你在 action 抛出错误或 reject 时执行一个回调函数。这些函数对于追踪运行时错误非常有用.</p>
<p>这里有一个例子，在运行 action 之前以及 action resolve/reject 之后打印日志记录。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unsubscribe = someStore.$onAction(</span><br><span class="line">  (&#123;</span><br><span class="line">    name, <span class="comment">// action 名称</span></span><br><span class="line">    store, <span class="comment">// store 实例，类似 `someStore`</span></span><br><span class="line">    args, <span class="comment">// 传递给 action 的参数数组</span></span><br><span class="line">    after, <span class="comment">// 在 action 返回或解决后的钩子</span></span><br><span class="line">    onError, <span class="comment">// action 抛出或拒绝的钩子</span></span><br><span class="line">  &#125;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 为这个特定的 action 调用提供一个共享变量</span></span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="comment">// 这将在执行 "store "的 action 之前触发。</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Start "<span class="subst">$&#123;name&#125;</span>" with params [<span class="subst">$&#123;args.join(<span class="string">', '</span>)&#125;</span>].`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这将在 action 成功并完全运行后触发。</span></span><br><span class="line">    <span class="comment">// 它等待着任何返回的 promise</span></span><br><span class="line">    after(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(</span><br><span class="line">        <span class="string">`Finished "<span class="subst">$&#123;name&#125;</span>" after <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">          <span class="built_in">Date</span>.now() - startTime</span></span></span><br><span class="line"><span class="string"><span class="subst">        &#125;</span>ms.\nResult: <span class="subst">$&#123;result&#125;</span>.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 action 抛出或返回一个拒绝的 promise，这将触发</span></span><br><span class="line">    onError(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(</span><br><span class="line">        <span class="string">`Failed "<span class="subst">$&#123;name&#125;</span>" after <span class="subst">$&#123;<span class="built_in">Date</span>.now() - startTime&#125;</span>ms.\nError: <span class="subst">$&#123;error&#125;</span>.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动删除监听器</span></span><br><span class="line">unsubscribe()</span><br></pre></td></tr></table></figure>
<p>默认情况下，<strong><em>action</em></strong> 订阅器会被绑定到添加它们的组件上(如果 store 在组件的 <code>setup()</code> 内)。这意味着，当该组件被卸载时，它们将被自动删除。如果你想在组件卸载后依旧保留它们，请将 <code>true</code> 作为第二个参数传递给 <strong><em>action</em></strong> 订阅器，以便将其从当前组件中分离：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">const</span> someStore = useSomeStore()</span><br><span class="line"><span class="comment">// 此订阅器即便在组件卸载之后仍会被保留</span></span><br><span class="line">someStore.$onAction(callback, <span class="literal">true</span>)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>由于有了底层 API 的支持，Pinia store 现在完全支持扩展。以下是你可以扩展的内容：</p>
<ul>
<li>为 store 添加新的属性</li>
<li>定义 store 时增加新的选项</li>
<li>为 store 增加新的方法</li>
<li>包装现有的方法</li>
<li>改变甚至取消 action</li>
<li>实现副作用，如<strong>本地存储</strong></li>
<li>仅应用插件于特定 store</li>
</ul>
<p>插件是通过 <code>pinia.use()</code> 添加到 pinia 实例的。最简单的例子是通过返回一个对象将一个静态属性添加到所有 store。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建的每个 store 中都会添加一个名为 `secret` 的属性。</span></span><br><span class="line"><span class="comment">// 在安装此插件后，插件可以保存在不同的文件中</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SecretPiniaPlugin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">secret</span>: <span class="string">'the cake is a lie'</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="comment">// 将该插件交给 Pinia</span></span><br><span class="line">pinia.use(SecretPiniaPlugin)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在另一个文件中</span></span><br><span class="line"><span class="keyword">const</span> store = useStore()</span><br><span class="line">store.secret <span class="comment">// 'the cake is a lie'</span></span><br></pre></td></tr></table></figure>
<p>这对添加全局对象很有用，如路由器、modal 或 toast 管理器。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Pinia 插件是一个函数，可以选择性地返回要添加到 store 的属性。它接收一个可选参数，即 context。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">myPiniaPlugin</span>(<span class="params">context</span>) </span>&#123;</span><br><span class="line">  context.pinia <span class="comment">// 用 `createPinia()` 创建的 pinia。</span></span><br><span class="line">  context.app <span class="comment">// 用 `createApp()` 创建的当前应用(仅 Vue 3)。</span></span><br><span class="line">  context.store <span class="comment">// 该插件想扩展的 store</span></span><br><span class="line">  context.options <span class="comment">// 定义传给 `defineStore()` 的 store 的可选对象。</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后用 <code>pinia.use()</code> 将这个函数传给 <code>pinia</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pinia.use(myPiniaPlugin)</span><br></pre></td></tr></table></figure>
<h3 id="扩展-store"><a href="#扩展-store" class="headerlink" title="扩展 store"></a>扩展 store</h3><p>你可以通过返回一个对象来向 store 添加新的属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pinia.use(<span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">hello</span>: <span class="string">'world'</span> &#125;))</span><br></pre></td></tr></table></figure>
<p>你也可以直接在 store 上设置该属性，但可以的话，请使用返回对象的方法，这样它们就能被 devtools 自动追踪到：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pinia.use(<span class="function">(<span class="params">&#123; store &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  store.hello = <span class="string">'world'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>任何由插件返回的属性都会被 devtools 自动追踪，所以如果你想在 devtools 中调试 hello 属性，为了使 devtools 能追踪到 hello，请确保在 dev 模式下将其添加到 store._customProperties 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上文示例</span></span><br><span class="line">pinia.use(<span class="function">(<span class="params">&#123; store &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  store.hello = <span class="string">'world'</span></span><br><span class="line">  <span class="comment">// 确保你的构建工具能处理这个问题，webpack 和 vite 在默认情况下应该能处理。</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">    <span class="comment">// 添加你在 store 中设置的键值</span></span><br><span class="line">    store._customProperties.add(<span class="string">'hello'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="在组件外使用-store"><a href="#在组件外使用-store" class="headerlink" title="在组件外使用 store"></a>在组件外使用 store</h2><p>Pinia store 依靠 <code>pinia</code> 实例在所有调用中共享同一个 store 实例。大多数时候，只需调用你定义的 <code>useStore()</code> 函数，完全开箱即用。例如，在 <code>setup()</code> 中，你不需要再做任何事情。但在组件之外，情况就有点不同了。 实际上，<code>useStore()</code> 给你的 <code>app</code> 自动注入了 <code>pinia</code> 实例。这意味着，如果 <code>pinia</code> 实例不能自动注入，你必须手动提供给 <code>useStore()</code> 函数。 你可以根据不同的应用，以不同的方式解决这个问题。</p>
<h3 id="单页面应用"><a href="#单页面应用" class="headerlink" title="单页面应用"></a>单页面应用</h3><p>如果你不做任何 SSR(服务器端渲染)，在用 <code>app.use(pinia)</code> 安装 pinia 插件后，对 <code>useStore()</code> 的任何调用都会正常执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useUserStore &#125; <span class="keyword">from</span> <span class="string">'@/stores/user'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌  失败，因为它是在创建 pinia 之前被调用的</span></span><br><span class="line"><span class="keyword">const</span> userStore = useUserStore()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line">app.use(pinia)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 成功，因为 pinia 实例现在激活了</span></span><br><span class="line"><span class="keyword">const</span> userStore = useUserStore()</span><br></pre></td></tr></table></figure>
<p>为确保 pinia 实例被激活，最简单的方法就是将 <code>useStore()</code> 的调用放在 pinia 安装后才会执行的函数中。</p>
<p>让我们来看看这个在 Vue Router 的导航守卫中使用 store 的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter &#125; <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"><span class="keyword">const</span> router = createRouter(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 由于引入顺序的问题，这将失败</span></span><br><span class="line"><span class="keyword">const</span> store = useStore()</span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 我们想要在这里使用 store</span></span><br><span class="line">  <span class="keyword">if</span> (store.isLoggedIn) next()</span><br><span class="line">  <span class="keyword">else</span> next(<span class="string">'/login'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ✅ 这样做是可行的，因为路由器是在其被安装之后开始导航的，</span></span><br><span class="line">  <span class="comment">// 而此时 Pinia 也已经被安装。</span></span><br><span class="line">  <span class="keyword">const</span> store = useStore()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (to.meta.requiresAuth &amp;&amp; !store.isLoggedIn) <span class="keyword">return</span> <span class="string">'/login'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="服务端渲染应用"><a href="#服务端渲染应用" class="headerlink" title="服务端渲染应用"></a>服务端渲染应用</h3><p>当处理服务端渲染时，你将必须把 <code>pinia</code> 实例传递给 <code>useStore()</code>。这可以防止 pinia 在不同的应用实例之间共享全局状态。</p>
<h2 id="服务端渲染-SSR"><a href="#服务端渲染-SSR" class="headerlink" title="服务端渲染 (SSR)"></a>服务端渲染 (SSR)</h2><p>只要你只在 <code>setup</code> 函数、<code>getter</code> 和 <code>action</code> 的顶部调用你定义的 <code>useStore()</code> 函数，那么使用 Pinia 创建 store 对于 SSR 来说应该是开箱即用的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="comment">// 这是可行的，</span></span><br><span class="line"><span class="comment">// 因为 pinia 知道在 `setup` 中运行的是什么程序。</span></span><br><span class="line"><span class="keyword">const</span> main = useMainStore()</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="在-setup-外部使用-store"><a href="#在-setup-外部使用-store" class="headerlink" title="在 setup() 外部使用 store"></a>在 setup() 外部使用 store</h3><p>如果你需要在其他地方使用 store，你需要将<strong>原本被传递给应用</strong> 的 <code>pinia</code> 实例传递给 <code>useStore()</code> 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line"></span><br><span class="line">app.use(router)</span><br><span class="line">app.use(pinia)</span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ✅这会正常工作，因为它确保了正确的 store 被用于</span></span><br><span class="line">  <span class="comment">// 当前正在运行的应用</span></span><br><span class="line">  <span class="keyword">const</span> main = useMainStore(pinia)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (to.meta.requiresAuth &amp;&amp; !main.isLoggedIn) <span class="keyword">return</span> <span class="string">'/login'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Pinia 会将自己作为 <code>$pinia</code> 添加到你的应用中，所以你可以在 <code>serverPrefetch()</code> 等函数中使用它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  serverPrefetch() &#123;</span><br><span class="line">    <span class="keyword">const</span> store = useStore(<span class="keyword">this</span>.$pinia)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="State-激活"><a href="#State-激活" class="headerlink" title="State 激活"></a>State 激活</h3><p>为了激活初始 state，你需要确保 rootState 包含在 HTML 中的某个地方，以便 Pinia 稍后能够接收到它。根据你服务端所渲染的内容，为了安全你应该转义 state。我们推荐 Nuxt 目前使用的 <a href="https://github.com/nuxt-contrib/devalue" target="_blank" rel="noopener">@nuxt/devalue</a>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> devalue <span class="keyword">from</span> <span class="string">'@nuxt/devalue'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">'pinia'</span></span><br><span class="line"><span class="comment">// 检索服务端的 rootState</span></span><br><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line">app.use(router)</span><br><span class="line">app.use(pinia)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染页面后，rootState 被建立，</span></span><br><span class="line"><span class="comment">// 可以直接在 `pinia.state.value`上读取。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化，转义(如果 state 的内容可以被用户改变，这点就非常重要，几乎都是这样的)</span></span><br><span class="line"><span class="comment">// 并将其放置在页面的某处</span></span><br><span class="line"><span class="comment">// 例如，作为一个全局变量。</span></span><br><span class="line">devalue(pinia.state.value)</span><br></pre></td></tr></table></figure>
<p>根据你服务端所渲染的内容，你将设置一个初始状态变量，该变量将在 HTML 中被序列化。你还应该保护自己免受 XSS 攻击。例如，在 <a href="https://github.com/frandiox/vite-ssr" target="_blank" rel="noopener">vite-ssr</a>中你可以使用transformState 选项 以及 <a href="https://github.com/frandiox/vite-ssr#state-serialization" target="_blank" rel="noopener">@nuxt/devalue</a>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> devalue <span class="keyword">from</span> <span class="string">'@nuxt/devalue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> viteSSR(</span><br><span class="line">  App,</span><br><span class="line">  &#123;</span><br><span class="line">    routes,</span><br><span class="line">    transformState(state) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">import</span>.meta.env.SSR ? devalue(state) : state</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  (&#123; initialState &#125;) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">import</span>.meta.env.SSR) &#123;</span><br><span class="line">      <span class="comment">// 序列化并设置为 window.__INITIAL_STATE__</span></span><br><span class="line">      initialState.pinia = pinia.state.value</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 在客户端，我们恢复 state</span></span><br><span class="line">      pinia.state.value = initialState.pinia</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>你可以根据你的需要使用 <code>@nuxt/devalue</code> 的<strong>其他替代品</strong>，例如，你也可以用 <code>JSON.stringify()/JSON.parse()</code> 来序列化和解析你的 state，这样你可以把性能提高很多。</p>
<p>也可以根据你的环境调整这个策略。但确保在客户端调用任何 <code>useStore()</code> 函数之前，激活 pinia 的 state。例如，如果我们将 state 序列化为一个 <code>&lt;script&gt;</code> 标签，并在客户端通过 <code>window.__pinia</code> 全局访问它，我们可以这样写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pinia = createPinia()</span><br><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line">app.use(pinia)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须由用户设置</span></span><br><span class="line"><span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">  pinia.state.value = <span class="built_in">JSON</span>.parse(<span class="built_in">window</span>.__pinia)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Nuxt"><a href="#Nuxt" class="headerlink" title="Nuxt"></a>Nuxt</h3><p>搭配 <strong>Nuxt</strong> 的 Pinia 更易用，因为 Nuxt 处理了很多与服务器端渲染有关的事情。例如，你不需要关心序列化或 XSS 攻击。Pinia 既支持 Nuxt Bridge 和 Nuxt 3，也支持纯 Nuxt 2。</p>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn add pinia @pinia/nuxt</span><br><span class="line"><span class="comment"># 或者使用 npm</span></span><br><span class="line">npm install pinia @pinia/nuxt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果你正在使用 npm，你可能会遇到 ERESOLVE unable to resolve dependency tree 错误。如果那样的话，将以下内容添加到 package.json 中：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"overrides"</span>: &#123;</span><br><span class="line">    <span class="attr">"vue"</span>: <span class="string">"latest"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>我们提供了一个 <strong><em>module</em></strong> 来为你处理一切，你只需要在 <code>nuxt.config.js</code> 文件的 <code>modules</code> 中添加它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nuxt.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineNuxtConfig(&#123;</span><br><span class="line">  <span class="comment">// ... 其他配置</span></span><br><span class="line">  modules: [</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="string">'@pinia/nuxt'</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这样配置就完成了，正常使用 store 就好啦!</p>
<h4 id="在-setup-外部使用-store-1"><a href="#在-setup-外部使用-store-1" class="headerlink" title="在 setup() 外部使用 store"></a>在 setup() 外部使用 store</h4><p>如果你想在 <code>setup()</code> 外部使用一个 store，记得把 <code>pinia</code> 对象传给 <code>useStore()</code>。我们会把它添加到<strong>上下文</strong>中，然后你就可以在 <code>asyncData()</code> 和 <code>fetch()</code> 中访问它了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">'~/stores/myStore'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  asyncData(&#123; $pinia &#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> store = useStore($pinia)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与 <code>onServerPrefetch()</code> 一样，如果你想在 a<code>syncData()</code> 中调用一个存储动作，你不需要做任何特别的事情。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line"><span class="keyword">const</span> store = useStore()</span><br><span class="line"><span class="keyword">const</span> &#123; data &#125; = <span class="keyword">await</span> useAsyncData(<span class="string">'user'</span>, () =&gt; store.fetchUser())</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="自动引入"><a href="#自动引入" class="headerlink" title="自动引入"></a>自动引入</h4><p>默认情况下，<code>@pinia/nuxt</code> 会暴露一个自动引入的方法：<code>usePinia()</code>，它类似于 <code>getActivePinia()</code>，但在 Nuxt 中效果更好。你可以添加自动引入来减轻你的开发工作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nuxt.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineNuxtConfig(&#123;</span><br><span class="line">  <span class="comment">// ... 其他配置</span></span><br><span class="line">  modules: [</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    [</span><br><span class="line">      <span class="string">'@pinia/nuxt'</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        autoImports: [</span><br><span class="line">          <span class="comment">// 自动引入 `defineStore()`</span></span><br><span class="line">          <span class="string">'defineStore'</span>,</span><br><span class="line">          <span class="comment">// 自动引入 `defineStore()` 并重命名为 `definePiniaStore()`</span></span><br><span class="line">          [<span class="string">'defineStore'</span>, <span class="string">'definePiniaStore'</span>],</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="纯-Nuxt-2"><a href="#纯-Nuxt-2" class="headerlink" title="纯 Nuxt 2"></a>纯 Nuxt 2</h4><p><code>@pinia/nuxt</code> v0.2.1 之前的版本中，Pinia 都支持 Nuxt 2。请确保在安装 pinia 的同时也安装 <a href="https://composition-api.nuxtjs.org/" target="_blank" rel="noopener">@nuxtjs/composition-api</a>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn add pinia @pinia/nuxt@0.2.1 @nuxtjs/composition-api</span><br><span class="line"><span class="comment"># 使用 npm</span></span><br><span class="line">npm install pinia @pinia/nuxt@0.2.1 @nuxtjs/composition-api</span><br></pre></td></tr></table></figure>
<p>我们提供了一个 <strong><em>module</em></strong> 来为你处理一切工作，你只需要在 <code>nuxt.config.js</code> 文件的 <code>buildModules</code> 中添加它。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nuxt.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ... 其他配置</span></span><br><span class="line">  buildModules: [</span><br><span class="line">    <span class="comment">// 仅支持 Nuxt 2:</span></span><br><span class="line">    <span class="comment">// https://composition-api.nuxtjs.org/getting-started/setup#quick-start</span></span><br><span class="line">    <span class="string">'@nuxtjs/composition-api/module'</span>,</span><br><span class="line">    <span class="string">'@pinia/nuxt'</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Pinia-搭配-Vuex-使用"><a href="#Pinia-搭配-Vuex-使用" class="headerlink" title="Pinia 搭配 Vuex 使用"></a>Pinia 搭配 Vuex 使用</h4><p>建议避免同时使用 Pinia 和 Vuex，但如果你确实需要同时使用，你需要告诉 Pinia 不要禁用它：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nuxt.config.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  buildModules: [</span><br><span class="line">    <span class="string">'@nuxtjs/composition-api/module'</span>,</span><br><span class="line">    [<span class="string">'@pinia/nuxt'</span>, &#123; <span class="attr">disableVuex</span>: <span class="literal">false</span> &#125;],</span><br><span class="line">  ],</span><br><span class="line">  <span class="comment">// ... 其他配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        
    </section>
</article>





<div class="comments">
    <div id="comments"></div>
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
    new Gitalk({
        clientID: "7fbe80427f54741e289f",
        clientSecret: "f34ed5fd92e54c9000bd37ba951948cb939deff5",
        repo: "sanonz.github.io",
        owner: "sanonz",
        admin: ["sanonz"],
        id: "2025/09/10/pina",
        distractionFreeMode: true,
        title: "再读 pinia 官方文档",
        body: "http://www.shuy.cc/2025/09/10/pina/",
        labels: []
    }).render('comments');
    </script>
</div>


        </div>
        <footer class="footer" style="color: #fff">
    <a href="https://beian.miit.gov.cn/" style="color: #fff" target="_blank">晋ICP备2024043727号-3</a>
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            console.log($(this).width())
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    
        <script src="/js/scrollspy.min.js"></script>
        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                // var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                // pageprev.css($.extend({left: hw + len}, styles));
                // pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                // pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
